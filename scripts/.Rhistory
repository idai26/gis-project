total_count = sum(cancellation_count),
n_airports = n(),
.groups = "drop"
)
# Step 2: Pack outer circles (one per cancellation reason)
outer_layout <- circleProgressiveLayout(reason_summary$total_count, sizetype = "area")
outer_circles <- bind_cols(reason_summary, outer_layout)
# Step 3: For each cancellation reason, pack inner circles (airports)
inner_data <- cancellations %>%
group_by(cancellation_reason) %>%
group_modify(~ {
# Pack circles for airports within this reason
inner_pack <- circleProgressiveLayout(.x$cancellation_count, sizetype = "area")
# Get the corresponding outer circle
outer <- outer_circles %>% filter(cancellation_reason == .y$cancellation_reason)
# Calculate scaling to fit inner circles within outer circle
# Find the bounding circle of inner packing
cx <- mean(inner_pack$x)
cy <- mean(inner_pack$y)
max_dist <- max(sqrt((inner_pack$x - cx)^2 + (inner_pack$y - cy)^2) + inner_pack$radius)
# Scale to fit within 75% of outer radius (leaving margin)
scale <- ifelse(max_dist > 0, (outer$radius * 0.85) / max_dist, 1)
# Transform coordinates
.x %>%
mutate(
x = outer$x + (inner_pack$x - cx) * scale,
y = outer$y + (inner_pack$y - cy) * scale,
radius = inner_pack$radius * scale
)
}) %>%
ungroup()
# Step 4: Plot
ggplot() +
# Outer circles (cancellation reasons)
geom_circle(
data = outer_circles,
aes(x0 = x, y0 = y, r = radius, fill = cancellation_reason),
alpha = 0.25,
color = "white",
linewidth = 3
) +
# Inner circles (individual airports)
geom_circle(
data = inner_data,
aes(x0 = x, y0 = y, r = radius, fill = cancellation_reason),
alpha = 0.75,
color = "white",
linewidth = 1
) +
# Outer labels (cancellation reasons)
geom_text(
data = outer_circles,
aes(x = x, y = y - radius * 0.85, label = cancellation_reason),
color = "darkgrey",
fontface = "bold",
size = 6
) +
# Inner labels (city names)
geom_text(
data = inner_data,
aes(x = x, y = y, label = city),
color = "white",
size = 2.5,
fontface = "bold"
) +
scale_fill_brewer(palette = "Set2") +
coord_equal() +
theme_void() +
theme(
legend.position = "none"
)
library(tidyverse)
library(sf)
library(spdep)
library(spatialreg)
library(mapview)
setwd("~/Library/CloudStorage/Box-Box/DSAN-6750/Minneapolis/scripts/")
# Load census data (both percentage and raw counts in one pass)
census_data <- read_csv("../data/processed/census/mpls_tracts_census.csv", show_col_types = FALSE) |>
mutate(GEOID = as.character(GEOID))
# Extract percentage variables for main analysis
census_data_pct <- census_data |>
select(c(1:10, 91, contains("pct_"), unemployment_rate))
# Extract raw count variables for LISA cluster analysis
census_data_raw <- census_data |>
select(GEOID,
# Race variables
race_total, race_white, race_black, race_asian,
# Hispanic variables
hisp_total, hisp_latino,
# Education variables (population 25+)
educ_total, educ_bachelors, educ_masters, educ_professional, educ_doctorate,
# School enrollment variables
school_total, school_undergrad, school_grad,
# Age variables
starts_with("age_"),
# Housing variables
tenure_total, tenure_owner, tenure_renter,
rent_burden_total, rent_burden_30_34, rent_burden_35_39,
rent_burden_40_49, rent_burden_50_plus,
# Language variables
lang_total, lang_english_only,
# Income (median)
med_hh_income)
# Load Frey vote share shapefile
frey_data_sf <- read_sf("../data/shapefiles/tracts/mpls_tract_frey_votes.shp") |>
st_transform(26915)
# Join all data sources
joined_data_sf <- census_data_pct |>
left_join(frey_data_sf, by = "GEOID") |>
st_as_sf()
# Create spatial weights matrix
nb <- poly2nb(joined_data_sf$geometry)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
# Census variables PCA
pca_census <- census_data_pct |>
select(-c(1:10)) |>
prcomp(scale. = TRUE)
factor_loadings_census <- pca_census$rotation |>
as.data.frame() |>
mutate(variable = rownames(pca_census$rotation)) |>
arrange(PC1)
# Join census PCA results to main dataset
# Create census PCA results as regular data frame
census_pca_results <- census_data_pct |>
select(GEOID) |>
bind_cols(as.data.frame(pca_census$x)) |>
rename_with(~ paste0("census_", .x), starts_with("PC"))
# Join census PCA to main dataset (frey_share_avg is already in joined_data_sf)
joined_data_pca_sf <- joined_data_sf |>
left_join(census_pca_results, by = "GEOID") |>
st_as_sf()
cat("\n=== Using Frey Average Vote Share as Dependent Variable ===\n")
cat("Variable: frey_share_avg (average across 2017, 2021, 2025 final rounds)\n")
cat("Range: [", round(min(joined_data_pca_sf$frey_share_avg, na.rm = TRUE), 2),
", ", round(max(joined_data_pca_sf$frey_share_avg, na.rm = TRUE), 2), "]\n")
cat("Mean: ", round(mean(joined_data_pca_sf$frey_share_avg, na.rm = TRUE), 2), "%\n\n")
View(frey_data_sf)
cat("\n=== Using Frey Average Vote Share as Dependent Variable ===\n")
cat("Variable: frey_share_avg (average across 2017, 2021, 2025 final rounds)\n")
cat("Range: [", round(min(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2),
", ", round(max(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2), "]\n")
cat("Mean: ", round(mean(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2), "%\n\n")
# Map plotting function
pca_map_plot <- function(data, pc, title = NULL) {
ggplot(data, aes(fill = !!sym(pc), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract")
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Calculate percentages from aggregated counts
calculate_percentages <- function(data) {
data |>
mutate(
pct_white = (race_white_sum / race_total_sum) * 100,
pct_black = (race_black_sum / race_total_sum) * 100,
pct_asian = (race_asian_sum / race_total_sum) * 100,
pct_hispanic = (hisp_latino_sum / hisp_total_sum) * 100,
pct_bachelors_plus = ((educ_bachelors_sum + educ_masters_sum + educ_professional_sum + educ_doctorate_sum) / educ_total_sum) * 100,
pct_higher_ed = ((school_undergrad_sum + school_grad_sum) / school_total_sum) * 100,
pct_age_0_17 = (age_0_17_sum / age_total_sum) * 100,
pct_age_18_34 = (age_18_34_sum / age_total_sum) * 100,
pct_age_35_49 = (age_35_49_sum / age_total_sum) * 100,
pct_age_50_64 = (age_50_64_sum / age_total_sum) * 100,
pct_age_65_plus = (age_65_plus_sum / age_total_sum) * 100,
pct_owner_occupied = (tenure_owner_sum / tenure_total_sum) * 100,
pct_rent_burdened = (rent_burden_30_plus_sum / rent_burden_total_sum) * 100,
pct_english_only = (lang_english_only_sum / lang_total_sum) * 100
)
}
# Plot Frey average vote share map
pca_map_plot(frey, "frey_share_avg", "Frey Average Vote Share")
# Plot Frey average vote share map
pca_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Calculate Moran's I for Frey Average Vote Share
moran_test_frey <- moran.test(joined_data_pca_sf$fry_sh_, lw)
print(moran_test_frey)
# Map plotting function
pca_map_plot <- function(data, pc, title = NULL) {
ggplot(data, aes(fill = !!sym(pc), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
legend.title = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Plot Frey average vote share map
pca_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Map plotting function
pca_map_plot <- function(data, pc, title = NULL) {
ggplot(data, aes(fill = !!sym(pc), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
legend.title = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Plot Frey average vote share map
pca_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Map plotting function
pca_map_plot <- function(data, pc, title = NULL) {
ggplot(data, aes(fill = !!sym(pc), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Plot Frey average vote share map
pca_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
mapview_map_plot <- function(data, variable, title = NULL) {
mapview(data, zcol = variable, legend = TRUE, main = title)
}
# Calculate Moran's I for Frey Average Vote Share
moran_test_frey <- moran.test(joined_data_pca_sf$fry_sh_, lw)
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
mapview_map_plot <- function(data, variable, title = NULL) {
# Create color palette matching map_plot gradient2 scale
# low="#2166ac", mid="#f7f7f7", high="#b2182b"
color_palette <- colorRampPalette(c("#2166ac", "#f7f7f7", "#b2182b"))
# Create popup text with title and rounded value (1 decimal place)
popup_values <- paste0(
"<b>", title, "</b><br>",
title, ": ", round(data[[variable]], 1)
)
mapview(
data,
zcol = variable,
layer.name = title,
legend = TRUE,
col.regions = color_palette(100),
popup = popup_values
)
}
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
mapview_map_plot <- function(data, variable, title = NULL) {
# Create color palette matching map_plot gradient2 scale
# low="#2166ac", mid="#f7f7f7", high="#b2182b"
color_palette <- colorRampPalette(c("#2166ac", "#f7f7f7", "#b2182b"))
# Create tooltip label with title and rounded value (1 decimal place)
label_values <- paste0(title, ": ", round(data[[variable]], 1))
mapview(
data,
zcol = variable,
layer.name = title,
legend = TRUE,
col.regions = color_palette(100),
label = label_values
)
}
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Calculate Moran's I for Frey Average Vote Share
moran_test_frey <- moran.test(joined_data_pca_sf$fry_sh_, lw)
print(moran_test_frey)
# Calculate Local Moran's I (LISA) for Frey Average Vote Share
lisa_frey <- localmoran(joined_data_pca_sf$frey_share_avg, lw)
# Calculate Local Moran's I (LISA) for Frey Average Vote Share
lisa_frey <- localmoran(joined_data_pca_sf$fry_sh_, lw)
# Add LISA results and create cluster classifications
joined_data_pca_sf <- joined_data_pca_sf |>
mutate(
lisa_I = lisa_frey[, 1],
lisa_p = lisa_frey[, 5],
lisa_z = lisa_frey[, 4],
frey_mean = mean(fry_sh_, na.rm = TRUE),
frey_lag = lag.listw(lw, fry_sh_),
frey_hl = if_else(fry_sh_ >= frey_mean, "High", "Low"),
lag_hl = if_else(frey_lag >= frey_mean, "High", "Low"),
significant = lisa_p < 0.05,
lisa_cluster = case_when(
!significant ~ "Not Significant",
frey_hl == "High" & lag_hl == "High" ~ "High-High",
frey_hl == "Low" & lag_hl == "Low" ~ "Low-Low",
frey_hl == "High" & lag_hl == "Low" ~ "High-Low",
frey_hl == "Low" & lag_hl == "High" ~ "Low-High",
TRUE ~ "Not Significant"
),
lisa_cluster = factor(
lisa_cluster,
levels = c("High-High", "Low-Low", "High-Low", "Low-High", "Not Significant")
)
)
# Print LISA cluster summary
cat("\n=== LISA Cluster Summary for Frey Average Vote Share ===\n")
print(table(joined_data_pca_sf$lisa_cluster))
cat("Percent significant:",
round(100 * sum(joined_data_pca_sf$significant) / nrow(joined_data_pca_sf), 1), "%\n\n")
# Create LISA cluster map
lisa_colors <- c(
"High-High" = "#d7191c",
"Low-Low" = "#2b83ba",
"High-Low" = "#fdae61",
"Low-High" = "#abdda4",
"Not Significant" = "#f0f0f0"
)
lisa_map <- ggplot(joined_data_pca_sf) +
geom_sf(aes(fill = lisa_cluster), color = "white", size = 0.1) +
scale_fill_manual(name = "LISA Clusters", values = lisa_colors, drop = FALSE) +
labs(
title = "LISA Clusters - Frey Average Vote Share",
subtitle = paste0(
"Global Moran's I = ", round(moran_test_frey$estimate[1], 3),
", p < 0.001"
)
) +
theme_minimal() +
theme(
legend.position = "right",
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
print(lisa_map)
# Join raw counts to LISA cluster data
joined_data_with_counts <- joined_data_pca_sf |>
st_drop_geometry() |>
select(GEOID, lisa_cluster) |>
left_join(census_data_raw, by = "GEOID")
# Function to aggregate counts by group
aggregate_counts <- function(data, group_var = "lisa_cluster") {
data |>
group_by(across(all_of(group_var))) |>
summarise(
n_tracts = n(),
# Race aggregations
race_total_sum = sum(race_total, na.rm = TRUE),
race_white_sum = sum(race_white, na.rm = TRUE),
race_black_sum = sum(race_black, na.rm = TRUE),
race_asian_sum = sum(race_asian, na.rm = TRUE),
# Hispanic aggregations
hisp_total_sum = sum(hisp_total, na.rm = TRUE),
hisp_latino_sum = sum(hisp_latino, na.rm = TRUE),
# Education aggregations
educ_total_sum = sum(educ_total, na.rm = TRUE),
educ_bachelors_sum = sum(educ_bachelors, na.rm = TRUE),
educ_masters_sum = sum(educ_masters, na.rm = TRUE),
educ_professional_sum = sum(educ_professional, na.rm = TRUE),
educ_doctorate_sum = sum(educ_doctorate, na.rm = TRUE),
# School enrollment aggregations
school_total_sum = sum(school_total, na.rm = TRUE),
school_undergrad_sum = sum(school_undergrad, na.rm = TRUE),
school_grad_sum = sum(school_grad, na.rm = TRUE),
# Age aggregations
age_total_sum = sum(age_total, na.rm = TRUE),
age_0_17_sum = sum(
age_m_under5 + age_m_5_9 + age_m_10_14 + age_m_15_17 +
age_f_under5 + age_f_5_9 + age_f_10_14 + age_f_15_17,
na.rm = TRUE
),
age_18_34_sum = sum(
age_m_18_19 + age_m_20 + age_m_21 + age_m_22_24 + age_m_25_29 + age_m_30_34 +
age_f_18_19 + age_f_20 + age_f_21 + age_f_22_24 + age_f_25_29 + age_f_30_34,
na.rm = TRUE
),
age_35_49_sum = sum(
age_m_35_39 + age_m_40_44 + age_m_45_49 +
age_f_35_39 + age_f_40_44 + age_f_45_49,
na.rm = TRUE
),
age_50_64_sum = sum(
age_m_50_54 + age_m_55_59 + age_m_60_61 + age_m_62_64 +
age_f_50_54 + age_f_55_59 + age_f_60_61 + age_f_62_64,
na.rm = TRUE
),
age_65_plus_sum = sum(
age_m_65_66 + age_m_67_69 + age_m_70_74 + age_m_75_79 + age_m_80_84 + age_m_85_plus +
age_f_65_66 + age_f_67_69 + age_f_70_74 + age_f_75_79 + age_f_80_84 + age_f_85_plus,
na.rm = TRUE
),
# Housing aggregations
tenure_total_sum = sum(tenure_total, na.rm = TRUE),
tenure_owner_sum = sum(tenure_owner, na.rm = TRUE),
tenure_renter_sum = sum(tenure_renter, na.rm = TRUE),
rent_burden_total_sum = sum(rent_burden_total, na.rm = TRUE),
rent_burden_30_plus_sum = sum(
rent_burden_30_34 + rent_burden_35_39 + rent_burden_40_49 + rent_burden_50_plus,
na.rm = TRUE
),
# Language aggregations
lang_total_sum = sum(lang_total, na.rm = TRUE),
lang_english_only_sum = sum(lang_english_only, na.rm = TRUE),
# Income
median_hh_income_mean = mean(med_hh_income, na.rm = TRUE),
.groups = "drop"
) |>
calculate_percentages()
}
# Aggregate by LISA cluster
lisa_aggregated_counts <- aggregate_counts(joined_data_with_counts, "lisa_cluster")
# Aggregate for Minneapolis total (create dummy group variable for all data)
mpls_aggregated_counts <- joined_data_with_counts |>
mutate(lisa_cluster = "Minneapolis Total") |>
aggregate_counts("lisa_cluster")
# Rename clusters for display
lisa_aggregated_counts <- lisa_aggregated_counts |>
mutate(
lisa_cluster = case_when(
lisa_cluster == "High-High" ~ "Progressive Stronghold",
lisa_cluster == "Low-Low" ~ "Moderate Stronghold",
TRUE ~ as.character(lisa_cluster)
)
)
# Combine and filter
lisa_summary_filtered <- bind_rows(lisa_aggregated_counts, mpls_aggregated_counts) |>
filter(lisa_cluster %in% c("Progressive Stronghold", "Moderate Stronghold", "Minneapolis Total"))
# Display comparison table
census_vars_to_compare <- c(
"pct_white", "pct_black", "pct_asian", "pct_hispanic",
"pct_bachelors_plus", "pct_higher_ed",
"pct_age_0_17", "pct_age_18_34", "pct_age_35_49", "pct_age_50_64", "pct_age_65_plus",
"pct_owner_occupied", "pct_rent_burdened",
"pct_english_only", "median_hh_income_mean"
)
comparison_table <- lisa_summary_filtered |>
select(lisa_cluster, n_tracts, all_of(census_vars_to_compare)) |>
rename(med_hh_income = median_hh_income_mean)
cat("\n=== Census Characteristics by Cluster (Aggregated from Raw Counts) ===\n")
cat("Based on LISA clusters for Frey Average Vote Share\n")
cat("Progressive Stronghold = High-High LISA clusters (High Frey support)\n")
cat("Moderate Stronghold = Low-Low LISA clusters (Low Frey support)\n\n")
print(comparison_table, width = Inf)
predictor_vars <- c(
"pct_white", "pct_bachelors_plus", "med_hh_income", "pct_higher_ed", "pct_english_only",
"pct_owner_occupied", "pct_wfh", "pct_transit", "pct_drive_alone",
"pct_rent_burdened", "pct_built_post2000", "pct_multifamily",
"pct_moved_2021_later", "pct_same_sex_hh",
"pct_age_18_34", "pct_age_65_plus", "unemployment_rate"
)
predictor_vars_census <- paste0("census_PC", 1:10)
# Linear Regression (OLS)
formula_linear <- as.formula(paste("fry_sh_ ~", paste(predictor_vars, collapse = " + ")))
model_linear <- lm(formula_linear, data = joined_data_pca_sf)
print(summary(model_linear))
joined_data_pca_sf$linear_resids <- model_linear$residuals
pca_map_plot(joined_data_pca_sf, "linear_resids", "Linear Regression Residuals (Frey Average Vote Share)")
moran_test_linear_resids <- moran.test(joined_data_pca_sf$linear_resids, lw)
print(moran_test_linear_resids)
# SAR Model with Raw Census Variables
model_sar <- errorsarlm(formula_linear, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sar))
joined_data_pca_sf$sp_resids <- model_sar$residuals
pca_map_plot(joined_data_pca_sf, "sp_resids", "Spatial Autoregressive Residuals (Frey Average Vote Share)")
moran_test_sar_resids <- moran.test(joined_data_pca_sf$sp_resids, lw)
print(moran_test_sar_resids)
# SAR Model with Census PCA
formula_census <- as.formula(paste("fry_sh_ ~", paste(predictor_vars_census, collapse = " + ")))
model_sar_census <- errorsarlm(formula_census, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sar_census))
joined_data_pca_sf$sp_resids_census <- model_sar_census$residuals
pca_map_plot(joined_data_pca_sf, "sp_resids_census", "Spatial Autoregressive Residuals w/ Census PCA (Frey Average Vote Share)")
# SAC Model (Spatial Autocorrelation) - Both Spatial Error and Lagged Dependent Variable
# This model includes both lambda (spatial error) and rho (spatial lag)
model_sac <- sacsarlm(formula_linear, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sac))
joined_data_pca_sf$sac_resids <- model_sac$residuals
pca_map_plot(joined_data_pca_sf, "sac_resids", "SAC Model Residuals (Spatial Error + Lag) (Frey Average Vote Share)")
moran_test_sac_resids <- moran.test(joined_data_pca_sf$sac_resids, lw)
print(moran_test_sac_resids)
# SAC Model with Census PCA
model_sac_census <- sacsarlm(formula_census, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sac_census))
joined_data_pca_sf$sac_resids_census <- model_sac_census$residuals
pca_map_plot(joined_data_pca_sf, "sac_resids_census", "SAC Model Residuals w/ Census PCA (Spatial Error + Lag) (Frey Average Vote Share)")
# Mapview visualization
pca_color_palette <- colorRampPalette(c("#2166ac", "#f7f7f7", "#b2182b"))
mapview(joined_data_pca_sf, zcol = "fry_sh_", col.regions = pca_color_palette(100))
source("~/.active-rstudio-document")
