print()
}
}
library(tidyverse)
library(sf)
library(spdep)
library(spatialreg)
library(mapview)
setwd("~/Library/CloudStorage/Box-Box/DSAN-6750/Minneapolis/scripts/")
# ==========================================================================
library(tidyverse)
library(sf)
library(spdep)
library(spatialreg)
library(mapview)
setwd("~/Library/CloudStorage/Box-Box/DSAN-6750/Minneapolis/scripts/")
# ============================================================================
# DATA LOADING
# ============================================================================
# Load census data (both percentage and raw counts in one pass)
census_data <- read_csv("../data/processed/census/mpls_tracts_census.csv", show_col_types = FALSE) |>
mutate(GEOID = as.character(GEOID))
# Extract percentage variables for main analysis
census_data_pct <- census_data |>
select(c(1:10, 91, contains("pct_"), unemployment_rate))
# Extract raw count variables for LISA cluster analysis
census_data_raw <- census_data |>
select(GEOID,
# Race variables
race_total, race_white, race_black, race_asian,
# Hispanic variables
hisp_total, hisp_latino,
# Education variables (population 25+)
educ_total, educ_bachelors, educ_masters, educ_professional, educ_doctorate,
# School enrollment variables
school_total, school_undergrad, school_grad,
# Age variables
starts_with("age_"),
# Housing variables
tenure_total, tenure_owner, tenure_renter,
rent_burden_total, rent_burden_30_34, rent_burden_35_39,
rent_burden_40_49, rent_burden_50_plus,
# Language variables
lang_total, lang_english_only,
# Income (median)
med_hh_income)
# Load Frey vote share shapefile
frey_data_sf <- read_sf("../data/shapefiles/tracts/mpls_tract_frey_votes.shp") |>
st_transform(26915)
# Join all data sources
joined_data_sf <- census_data_pct |>
left_join(frey_data_sf, by = "GEOID") |>
st_as_sf()
# Create spatial weights matrix
nb <- poly2nb(joined_data_sf$geometry)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
# ============================================================================
# PRINCIPAL COMPONENTS ANALYSIS (Census Only)
# ============================================================================
# Census variables PCA
pca_census <- census_data_pct |>
select(-c(1:10)) |>
prcomp(scale. = TRUE)
factor_loadings_census <- pca_census$rotation |>
as.data.frame() |>
mutate(variable = rownames(pca_census$rotation)) |>
arrange(PC1)
# Join census PCA results to main dataset
# Create census PCA results as regular data frame
census_pca_results <- census_data_pct |>
select(GEOID) |>
bind_cols(as.data.frame(pca_census$x)) |>
rename_with(~ paste0("census_", .x), starts_with("PC"))
# Join census PCA to main dataset
joined_data_pca_sf <- joined_data_sf |>
left_join(census_pca_results, by = "GEOID") |>
st_as_sf()
cat("\n=== Using Frey Average Vote Share as Dependent Variable ===\n")
cat("Variable: fry_sh_ (average across 2017, 2021, 2025 final rounds)\n")
cat("Range: [", round(min(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2),
", ", round(max(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2), "]\n")
cat("Mean: ", round(mean(joined_data_pca_sf$fry_sh_, na.rm = TRUE), 2), "%\n\n")
# ============================================================================
# HELPER FUNCTIONS
# ============================================================================
# Map plotting function
map_plot <- function(data, variable, title = NULL) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
mapview_map_plot <- function(data, variable, title = NULL) {
# Create color palette matching map_plot gradient2 scale
# low="#2166ac", mid="#f7f7f7", high="#b2182b"
color_palette <- colorRampPalette(c("#2166ac", "#f7f7f7", "#b2182b"))
# Create tooltip label with title and rounded value (1 decimal place)
label_values <- paste0(title, ": ", round(data[[variable]], 1))
mapview(
data,
zcol = variable,
layer.name = title,
legend = TRUE,
col.regions = color_palette(100),
label = label_values
)
}
# Calculate percentages from aggregated counts
calculate_percentages <- function(data) {
data |>
mutate(
pct_white = (race_white_sum / race_total_sum) * 100,
pct_black = (race_black_sum / race_total_sum) * 100,
pct_asian = (race_asian_sum / race_total_sum) * 100,
pct_hispanic = (hisp_latino_sum / hisp_total_sum) * 100,
pct_bachelors_plus = ((educ_bachelors_sum + educ_masters_sum + educ_professional_sum + educ_doctorate_sum) / educ_total_sum) * 100,
pct_higher_ed = ((school_undergrad_sum + school_grad_sum) / school_total_sum) * 100,
pct_age_0_17 = (age_0_17_sum / age_total_sum) * 100,
pct_age_18_34 = (age_18_34_sum / age_total_sum) * 100,
pct_age_35_49 = (age_35_49_sum / age_total_sum) * 100,
pct_age_50_64 = (age_50_64_sum / age_total_sum) * 100,
pct_age_65_plus = (age_65_plus_sum / age_total_sum) * 100,
pct_owner_occupied = (tenure_owner_sum / tenure_total_sum) * 100,
pct_rent_burdened = (rent_burden_30_plus_sum / rent_burden_total_sum) * 100,
pct_english_only = (lang_english_only_sum / lang_total_sum) * 100
)
}
# ============================================================================
# EXPLORATORY ANALYSIS
# ============================================================================
# Plot Frey average vote share map
map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Calculate Moran's I for Frey Average Vote Share
moran_test_frey <- moran.test(joined_data_pca_sf$fry_sh_, lw)
print(moran_test_frey)
# ============================================================================
# SPATIAL REGRESSION MODELS
# ============================================================================
# Define predictor variables
predictor_vars <- c(
"pct_white", "pct_bachelors_plus", "med_hh_income", "pct_higher_ed", "pct_english_only",
"pct_owner_occupied", "pct_wfh", "pct_transit", "pct_drive_alone",
"pct_rent_burdened", "pct_built_post2000", "pct_multifamily",
"pct_moved_2021_later", "pct_same_sex_hh",
"pct_age_18_34", "pct_age_65_plus", "unemployment_rate"
)
predictor_vars <- c(
"pct_white", "pct_bachelors_plus", "med_hh_income", "pct_higher_ed", "pct_english_only",
"pct_owner_occupied", "pct_rent_burdened", "pct_built_post2000", "pct_multifamily",
"pct_moved_2021_later", "pct_same_sex_hh",
"pct_age_18_34", "pct_age_65_plus", "unemployment_rate"
)
predictor_vars_census <- paste0("census_PC", 1:10)
# Linear Regression (OLS)
formula_linear <- as.formula(paste("fry_sh_ ~", paste(predictor_vars, collapse = " + ")))
model_linear <- lm(formula_linear, data = joined_data_pca_sf)
print(summary(model_linear))
joined_data_pca_sf$linear_resids <- model_linear$residuals
map_plot(joined_data_pca_sf, "linear_resids", "Linear Regression Residuals (Frey Average Vote Share)")
map_plot(joined_data_pca_sf, "linear_resids", "Linear Regression Residuals \n (Frey Average Vote Share)")
# SAR Model with Raw Census Variables
model_sar <- errorsarlm(formula_linear, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sar))
joined_data_pca_sf$sp_resids <- model_sar$residuals
map_plot(joined_data_pca_sf, "sp_resids", "Spatial Autoregressive Residuals (Frey Average Vote Share)")
moran_test_sar_resids <- moran.test(joined_data_pca_sf$sp_resids, lw)
print(moran_test_sar_resids)
# SAR Model with Census PCA
formula_census <- as.formula(paste("fry_sh_ ~", paste(predictor_vars_census, collapse = " + ")))
model_sar_census <- errorsarlm(formula_census, data = joined_data_pca_sf, listw = lw, Durbin = FALSE)
print(summary(model_sar_census))
joined_data_pca_sf$sp_resids_census <- model_sar_census$residuals
map_plot(joined_data_pca_sf, "sp_resids_census", "Spatial Autoregressive Residuals w/ Census PCA (Frey Average Vote Share)")
map_plot(joined_data_sf, "linear_resids", "Linear Regression Residuals\n (Frey Average Vote Share)")
joined_data_sf$linear_resids <- model_linear$residuals
map_plot(joined_data_sf, "linear_resids", "Linear Regression Residuals\n (Frey Average Vote Share)")
moran_test_linear_resids <- moran.test(joined_data_sf$linear_resids, lw)
print(moran_test_linear_resids)
# SAR Model with Raw Census Variables
model_sar <- errorsarlm(formula_linear, data = joined_data_sf, listw = lw, Durbin = FALSE)
print(summary(model_sar))
joined_data_sf$sp_resids <- model_sar$residuals
map_plot(joined_data_sf, "sp_resids", "Spatial Autoregressive Residuals\n (Frey Average Vote Share)")
moran_test_sar_resids <- moran.test(joined_data_sf$sp_resids, lw)
print(moran_test_sar_resids)
# Map plotting function
map_plot <- function(data, variable, title = NULL, subtitle = title) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share", "Avg. Share")
# Map plotting function
map_plot <- function(data, variable, title = NULL, subtitle = title) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Plot Frey average vote share map
map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share", "Avg. Share")
# Plot Frey average vote share map
map_plot(joined_data_sf, "fry_sh_", title = "Frey Average Vote Share", subtitle = "Avg. Share")
# Map plotting function
map_plot <- function(data, variable, title = NULL, subtitle = title) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(subtitle, " by Census Tract"),
fill = title
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Map plotting function
map_plot <- function(data, variable, title = NULL, subtitle = title) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = subtitle
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
# Plot Frey average vote share map
map_plot(joined_data_sf, "fry_sh_", title = "Frey Average Vote Share", subtitle = "Avg. Share")
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
map_plot(joined_data_sf, "linear_resids", "Linear Regression Residuals\n (Frey Average Vote Share)", "Residual")
map_plot(joined_data_sf, "sp_resids", "Spatial Autoregressive Residuals\n (Frey Average Vote Share)", "Residual")
moran_test_sar_resids <- moran.test(joined_data_sf$sp_resids, lw)
print(moran_test_sar_resids)
map_plot(joined_data_sf, "sp_resids", "Spatial Autoregressive Residuals\n (Frey Average Vote Share)", "Residual")
library(tidyverse)
library(sf)
library(spdep)
library(spatialreg)
library(mapview)
setwd("~/Library/CloudStorage/Box-Box/DSAN-6750/Minneapolis/scripts/")
# ============================================================================
# DATA LOADING
# ============================================================================
# Load census data (both percentage and raw counts in one pass)
census_data <- read_csv("../data/processed/census/mpls_tracts_census.csv", show_col_types = FALSE) |>
mutate(GEOID = as.character(GEOID))
# Extract percentage variables for main analysis
census_data_pct <- census_data |>
select(c(1:10, 91, contains("pct_"), unemployment_rate))
# Extract raw count variables for LISA cluster analysis
census_data_raw <- census_data |>
select(GEOID,
# Race variables
race_total, race_white, race_black, race_asian,
# Hispanic variables
hisp_total, hisp_latino,
# Education variables (population 25+)
educ_total, educ_bachelors, educ_masters, educ_professional, educ_doctorate,
# School enrollment variables
school_total, school_undergrad, school_grad,
# Age variables
starts_with("age_"),
# Housing variables
tenure_total, tenure_owner, tenure_renter,
rent_burden_total, rent_burden_30_34, rent_burden_35_39,
rent_burden_40_49, rent_burden_50_plus,
# Language variables
lang_total, lang_english_only,
# Income (median)
med_hh_income)
# Load Frey vote share shapefile
frey_data_sf <- read_sf("../data/shapefiles/tracts/mpls_tract_frey_votes.shp") |>
st_transform(26915)
# Join all data sources
joined_data_sf <- census_data_pct |>
left_join(frey_data_sf, by = "GEOID") |>
st_as_sf()
# Create spatial weights matrix
nb <- poly2nb(joined_data_sf$geometry)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
# Define predictor variables
predictor_vars <- c(
"pct_white", "pct_bachelors_plus", "med_hh_income", "pct_higher_ed", "pct_english_only",
"pct_owner_occupied", "pct_rent_burdened", "pct_built_post2000", "pct_multifamily",
"pct_moved_2021_later", "pct_same_sex_hh",
"pct_age_18_34", "pct_age_65_plus", "unemployment_rate"
)
# ============================================================================
# HELPER FUNCTIONS
# ============================================================================
# Map plotting function
map_plot <- function(data, variable, title = NULL, subtitle = title) {
ggplot(data, aes(fill = !!sym(variable), geometry = geometry)) +
geom_sf(color = "white", size = 0.1) +
scale_fill_gradient2(
low = "#2166ac",
mid = "#f7f7f7",
high = "#b2182b"
) +
labs(
title = paste0(title, " by Census Tract"),
fill = subtitle
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank()
)
}
mapview_map_plot <- function(data, variable, title = NULL) {
# Create color palette matching map_plot gradient2 scale
# low="#2166ac", mid="#f7f7f7", high="#b2182b"
color_palette <- colorRampPalette(c("#2166ac", "#f7f7f7", "#b2182b"))
# Create tooltip label with title and rounded value (1 decimal place)
label_values <- paste0(title, ": ", round(data[[variable]], 1))
mapview(
data,
zcol = variable,
layer.name = title,
legend = TRUE,
col.regions = color_palette(100),
label = label_values
)
}
# Calculate percentages from aggregated counts
calculate_percentages <- function(data) {
data |>
mutate(
pct_white = (race_white_sum / race_total_sum) * 100,
pct_black = (race_black_sum / race_total_sum) * 100,
pct_asian = (race_asian_sum / race_total_sum) * 100,
pct_hispanic = (hisp_latino_sum / hisp_total_sum) * 100,
pct_bachelors_plus = ((educ_bachelors_sum + educ_masters_sum + educ_professional_sum + educ_doctorate_sum) / educ_total_sum) * 100,
pct_higher_ed = ((school_undergrad_sum + school_grad_sum) / school_total_sum) * 100,
pct_age_0_17 = (age_0_17_sum / age_total_sum) * 100,
pct_age_18_34 = (age_18_34_sum / age_total_sum) * 100,
pct_age_35_49 = (age_35_49_sum / age_total_sum) * 100,
pct_age_50_64 = (age_50_64_sum / age_total_sum) * 100,
pct_age_65_plus = (age_65_plus_sum / age_total_sum) * 100,
pct_owner_occupied = (tenure_owner_sum / tenure_total_sum) * 100,
pct_rent_burdened = (rent_burden_30_plus_sum / rent_burden_total_sum) * 100,
pct_english_only = (lang_english_only_sum / lang_total_sum) * 100
)
}
# Calculate descriptive statistics and Moran's I for a variable
calculate_var_stats <- function(var_name, data, listw) {
var_values <- data[[var_name]]
# Calculate descriptive statistics
mean_val <- mean(var_values, na.rm = TRUE)
median_val <- median(var_values, na.rm = TRUE)
min_val <- min(var_values, na.rm = TRUE)
max_val <- max(var_values, na.rm = TRUE)
sd_val <- sd(var_values, na.rm = TRUE)
# Calculate Moran's I
moran_result <- moran.test(var_values, listw)
moran_i <- moran_result$estimate[1]
moran_p <- moran_result$p.value
# Return as data frame row
data.frame(
Variable = var_name,
Mean = mean_val,
Median = median_val,
Min = min_val,
Max = max_val,
SD = sd_val,
Moran_I = moran_i,
Moran_I_Pvalue = moran_p,
stringsAsFactors = FALSE
)
}
# ============================================================================
# EXPLORATORY ANALYSIS
# ============================================================================
# Plot Frey average vote share map
map_plot(joined_data_sf, "fry_sh_", title = "Frey Average Vote Share", subtitle = "Avg. Share")
mapview_map_plot(joined_data_sf, "fry_sh_", "Frey Average Vote Share")
# Calculate Moran's I for Frey Average Vote Share
moran_test_frey <- moran.test(joined_data_sf$fry_sh_, lw)
print(moran_test_frey)
# ============================================================================
# VARIABLE DESCRIPTIVE STATISTICS AND SPATIAL AUTOCORRELATION
# ============================================================================
# Dependent Variable Statistics
cat("\n")
cat("=", strrep("=", 78), "\n", sep = "")
cat("DEPENDENT VARIABLE: DESCRIPTIVE STATISTICS AND SPATIAL AUTOCORRELATION\n")
cat("=", strrep("=", 78), "\n", sep = "")
dep_var_stats <- calculate_var_stats("fry_sh_", joined_data_sf, lw)
cat("Variable: fry_sh_ (Frey Average Vote Share)\n")
cat("  Mean:   ", sprintf("%.4f", dep_var_stats$Mean), "\n", sep = "")
cat("  Median: ", sprintf("%.4f", dep_var_stats$Median), "\n", sep = "")
cat("  Min:    ", sprintf("%.4f", dep_var_stats$Min), "\n", sep = "")
cat("  Max:    ", sprintf("%.4f", dep_var_stats$Max), "\n", sep = "")
cat("  SD:     ", sprintf("%.4f", dep_var_stats$SD), "\n", sep = "")
cat("  Moran's I: ", sprintf("%.4f", dep_var_stats$Moran_I), " (p-value: ",
format.pval(dep_var_stats$Moran_I_Pvalue, digits = 4), ")\n", sep = "")
cat("\n")
# Predictor Variables Statistics
cat("=", strrep("=", 78), "\n", sep = "")
cat("PREDICTOR VARIABLES: DESCRIPTIVE STATISTICS AND SPATIAL AUTOCORRELATION\n")
cat("=", strrep("=", 78), "\n", sep = "")
# Calculate statistics for all predictor variables
predictor_stats_list <- lapply(predictor_vars, function(var) {
calculate_var_stats(var, joined_data_sf, lw)
})
predictor_stats_table <- do.call(rbind, predictor_stats_list)
# Print the table
print(predictor_stats_table, digits = 4, row.names = FALSE)
cat("\n")
# Save statistics tables to CSV files
write_csv(dep_var_stats, "../outputs/spatial_regression_dependent_var_stats.csv")
write_csv(predictor_stats_table, "../outputs/spatial_regression_predictor_vars_stats.csv")
cat("Statistics tables saved to outputs/ directory:\n")
cat("  - spatial_regression_dependent_var_stats.csv\n")
cat("  - spatial_regression_predictor_vars_stats.csv\n\n")
# ============================================================================
# SPATIAL REGRESSION MODELS
# ============================================================================
# Linear Regression (OLS)
formula_linear <- as.formula(paste("fry_sh_ ~", paste(predictor_vars, collapse = " + ")))
model_linear <- lm(formula_linear, data = joined_data_sf)
print(summary(model_linear))
# Extract and save OLS model summary
linear_summary <- summary(model_linear)
# Extract coefficients
ols_coefficients <- as.data.frame(linear_summary$coefficients)
ols_coefficients$Variable <- rownames(ols_coefficients)
ols_coefficients <- ols_coefficients |>
select(Variable, Estimate, `Std. Error`, `t value`, `Pr(>|t|)`) |>
rename(
StdError = `Std. Error`,
TValue = `t value`,
PValue = `Pr(>|t|)`
)
# Extract Moran's I for OLS residuals
moran_test_ols_resids <- moran.test(model_linear$residuals, lw)
print(moran_test_ols_resids)
# Extract fit statistics
ols_fit_stats <- data.frame(
Statistic = c("R-squared", "Adjusted R-squared", "F-statistic", "F p-value", "AIC", "BIC", "Residual SE"),
Value = c(
linear_summary$r.squared,
linear_summary$adj.r.squared,
linear_summary$fstatistic[1],
pf(linear_summary$fstatistic[1], linear_summary$fstatistic[2], linear_summary$fstatistic[3], lower.tail = FALSE),
AIC(model_linear),
BIC(model_linear),
linear_summary$sigma,
moran_test_ols_resids$estimate[1],
moran_test_ols_resids$p.value
)
)
